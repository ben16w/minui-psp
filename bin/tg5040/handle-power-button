#!/bin/sh
BIN_DIR="$(dirname "$0")"
PAK_DIR="$(dirname "$(dirname "$BIN_DIR")")"
PAK_NAME="$(basename "$PAK_DIR")"
PAK_NAME="${PAK_NAME%.*}"
[ -f "$USERDATA_PATH/$PAK_NAME/debug" ] && set -x

rm -f "$LOGS_PATH/$PAK_NAME.power-button.txt"
exec >>"$LOGS_PATH/$PAK_NAME.power-button.txt"
exec 2>&1

echo "$0" "$@"
cd "$PAK_DIR" || exit 1

architecture=arm
if uname -m | grep -q '64'; then
    architecture=arm64
fi

export PATH="$PAK_DIR/bin/$architecture:$PAK_DIR/bin/$PLATFORM:$PAK_DIR/bin:$PATH"

POWER_DEVICE="/dev/input/event1"
BUTTON_CODE="code 116 (KEY_POWER)"

SUSPEND_SCRIPT="$SYSTEM_PATH/bin/suspend"

execute_power_off() {
    echo "Shutting down the system..."
    # if command -v poweroff >/dev/null 2>&1; then
    # 	poweroff
    # elif command -v shutdown >/dev/null 2>&1; then
    # 	shutdown -h now
    # else
    # 	echo "No poweroff or shutdown command found. Attempting to halt."
    # 	halt
    # fi
}

execute_sleep() {
    PROCESS_PID="$1"

    if [ ! -f "$SUSPEND_SCRIPT" ]; then
        echo "Suspend script not found"
        return 1
    fi

    kill -STOP "$PROCESS_PID" || true
    chmod +x "$SUSPEND_SCRIPT"
    "$SUSPEND_SCRIPT"
    kill -CONT "$PROCESS_PID" || true
}

main() {
    echo "Starting the power button handler..."
    PROCESS_PID="$1"

    value_unpressed="value 0"
    value_pressed="value 1"
    value_held="value 2"
    is_pressed=false
    pressed_at=""

    evtest "$POWER_DEVICE" 2>/dev/null | while read -r line; do
        echo "A button was pressed"
        now="$(coreutils date +%s%N)"
        now="${now%??????}"
        start_power_off=false
        start_sleep=false

        if echo "$line" | grep "$BUTTON_CODE" | grep -q "$value_pressed"; then
            echo "The power button is pressed: time=$now"
            if [ "$is_pressed" = "false" ]; then
                echo "The power button was just pressed: time=$now"
                pressed_at="$now"
            fi
            is_pressed=true
        elif echo "$line" | grep "$BUTTON_CODE" | grep -q "$value_unpressed"; then
            if [ "$is_pressed" = "true" ]; then
                echo "The power button was just released: time=$now"
                time_since_power_pressed=$((now - pressed_at))
                if [ "$time_since_power_pressed" -ge 1000 ]; then
                    start_power_off=true
                # elif [ "$time_since_power_pressed" -lt 100 ]; then
                #     continue
                else
                    start_sleep=true
                fi
            fi
            is_pressed=false
            pressed_at=""
        elif echo "$line" | grep "$BUTTON_CODE" | grep -q "$value_held"; then
            echo "The power button is held: time=$now"
            is_pressed=true
            time_since_power_pressed=$((now - pressed_at))
            if [ "$time_since_power_pressed" -ge 1000 ]; then
                start_power_off=true
            fi
        elif echo "$line" | grep -q -v "$BUTTON_CODE"; then
            continue
        fi

        if [ "$start_sleep" = "true" ]; then
            echo "Power button pressed, suspending..."
            execute_sleep "$PROCESS_PID"
            kill $$
        elif [ "$start_power_off" = "true" ]; then
            echo "Power button pressed for more than 1 second, shutting down..."
            #execute_power_off
            kill $$
        fi

        sleep 0.02
    done
}

main "$@"