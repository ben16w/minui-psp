#!/bin/sh
BIN_DIR="$(dirname "$0")"
PAK_DIR="$(dirname "$(dirname "$BIN_DIR")")"
PAK_NAME="$(basename "$PAK_DIR")"
PAK_NAME="${PAK_NAME%.*}"

rm -f "$LOGS_PATH/$PAK_NAME.power-button.txt"
exec >>"$LOGS_PATH/$PAK_NAME.power-button.txt"
exec 2>&1

echo "$0" "$@"
cd "$PAK_DIR" || exit 1

architecture=arm
if uname -m | grep -q '64'; then
    architecture=arm64
fi

export PATH="$PAK_DIR/bin/$architecture:$PAK_DIR/bin/$PLATFORM:$PAK_DIR/bin:$PATH"

POWER_DEVICE="/dev/input/event1"
BUTTON_CODE="code 116 (KEY_POWER)"

SUSPEND_SCRIPT="$SYSTEM_PATH/bin/suspend"

execute_power_off() {
    echo "Shutting down the system..."
    # if command -v poweroff >/dev/null 2>&1; then
    # 	poweroff
    # elif command -v shutdown >/dev/null 2>&1; then
    # 	shutdown -h now
    # else
    # 	echo "No poweroff or shutdown command found. Attempting to halt."
    # 	halt
    # fi
}

execute_sleep() {
    set -x
    PROCESS_PID="$1"

    if [ ! -f "$SUSPEND_SCRIPT" ]; then
        echo "Suspend script not found"
        return 1
    fi

    kill -STOP "$PROCESS_PID" || true
    chmod +x "$SUSPEND_SCRIPT"
    "$SUSPEND_SCRIPT"
    kill -CONT "$PROCESS_PID" || true

}

main() {
    PROCESS_PID="$1"

    is_pressed=false
    pressed_at=""
    start_power_off=false
    start_sleep=false
    slept_at=""

    value_unpressed="value 0"
    value_pressed="value 1"
    value_held="value 2"

    evtest "$POWER_DEVICE" 2>/dev/null | while read -r line; do
        if echo "$line" | grep -q -v "$BUTTON_CODE"; then
            continue
        fi

        now="$(coreutils date +%s%N)"
        now="${now%??????}"

        if [ "$start_sleep" = "true" ]; then
            time_since_slept=$((now - slept_at))
            if [ "$time_since_slept" -ge 2000 ]; then
                start_sleep=false
                pressed_at=""
            fi
            continue
        fi


        if echo "$line" | grep "$BUTTON_CODE" | grep -q "$value_pressed"; then
            if [ "$is_pressed" = "false" ]; then
                pressed_at="$now"
            fi
            is_pressed=true
        elif echo "$line" | grep "$BUTTON_CODE" | grep -q "$value_unpressed"; then
            if [ "$is_pressed" = "true" ]; then
                time_since_power_pressed=$((now - pressed_at))
                if [ "$time_since_power_pressed" -ge 1000 ]; then
                    start_power_off=true
                else
                    start_sleep=true
                fi
            fi
            is_pressed=false
            pressed_at=""
        elif echo "$line" | grep "$BUTTON_CODE" | grep -q "$value_held"; then
            is_pressed=true
            time_since_power_pressed=$((now - pressed_at))
            if [ "$time_since_power_pressed" -ge 1000 ]; then
                start_power_off=true
            fi
        fi

        if [ "$start_power_off" = "true" ]; then
            sleep 1
            echo "Forcing a power off"
            execute_power_off
            #break
        elif [ "$start_sleep" = "true" ]; then
            echo "Going to sleep"
            execute_sleep "$1"
            slept_at="$(coreutils date +%s%N)"
            slept_at="${now%??????}"
        fi

        sleep 0.02
    done
}

main "$@"