#!/bin/sh
BIN_DIR="$(dirname "$0")"
PAK_DIR="$(dirname "$BIN_DIR")"
PAK_NAME="$(basename "$PAK_DIR")"
PAK_NAME="${PAK_NAME%.*}"
[ -f "$USERDATA_PATH/PSP-ppsspp/debug" ] && set -x

rm -f "$LOGS_PATH/$PAK_NAME.shutdown.txt"
exec >>"$LOGS_PATH/$PAK_NAME.shutdown.txt"
exec 2>&1

echo "$0" "$@"
cd "$PAK_DIR" || exit 1

architecture=arm
if uname -m | grep -q '64'; then
    architecture=arm64
fi

export PATH="$PAK_DIR/bin/$architecture:$PAK_DIR/bin/$PLATFORM:$PAK_DIR/bin:$PATH"

PPSSPP_BIN="PPSSPPSDL"

show_message() {
    message="$1"
    seconds="$2"

    if [ -z "$seconds" ]; then
        seconds="forever"
    fi

    killall minui-presenter >/dev/null 2>&1 || true
    echo "$message" 1>&2
    if [ "$seconds" = "forever" ]; then
        minui-presenter --message "$message" --timeout -1 &
    else
        minui-presenter --message "$message" --timeout "$seconds"
    fi
}

main() {
    PROCESS_PID=$(pgrep -f "$PPSSPP_BIN" | head -n 1)
    if [ -n "$PROCESS_PID" ]; then
        kill "$PROCESS_PID" || true
    fi

    show_message "Powering off" forever

    sync
    poweroff
    while :; do
        sleep 1
    done
}

main "$@"
